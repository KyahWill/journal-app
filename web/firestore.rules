rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // User profiles
    match /profiles/{userId} {
      // Users can read their own profile
      allow read: if isAuthenticated() && isOwner(userId);
      
      // Users can create their own profile
      allow create: if isAuthenticated() && isOwner(userId);
      
      // Users can update their own profile
      allow update: if isAuthenticated() && isOwner(userId);
      
      // No deletes allowed
      allow delete: if false;
    }
    
    // Journal entries
    match /journal_entries/{entryId} {
      // Users can read their own entries
      allow read: if isAuthenticated() && 
                     resource.data.user_id == request.auth.uid;
      
      // Users can create entries with their own user_id
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid &&
                       request.resource.data.keys().hasAll(['user_id', 'title', 'content', 'created_at', 'updated_at']);
      
      // Users can update their own entries
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid &&
                       request.resource.data.user_id == request.auth.uid;
      
      // Users can delete their own entries
      allow delete: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid;
    }
    
    // Chat sessions
    match /chat_sessions/{sessionId} {
      // Users can read their own sessions
      allow read: if isAuthenticated() && 
                     resource.data.user_id == request.auth.uid;
      
      // Users can create sessions with their own user_id
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid;
      
      // Users can update their own sessions
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid &&
                       request.resource.data.user_id == request.auth.uid;
      
      // Users can delete their own sessions
      allow delete: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid;
    }
    
    // User prompts
    match /user_prompts/{promptId} {
      // Users can read their own prompts
      allow read: if isAuthenticated() && 
                     resource.data.user_id == request.auth.uid;
      
      // Users can create prompts with their own user_id
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid &&
                       request.resource.data.keys().hasAll(['user_id', 'name', 'prompt_text', 'is_default', 'created_at', 'updated_at']) &&
                       request.resource.data.name.size() <= 100 &&
                       request.resource.data.prompt_text.size() <= 10000;
      
      // Users can update their own prompts
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid &&
                       request.resource.data.user_id == request.auth.uid &&
                       (!request.resource.data.keys().hasAny(['name']) || request.resource.data.name.size() <= 100) &&
                       (!request.resource.data.keys().hasAny(['prompt_text']) || request.resource.data.prompt_text.size() <= 10000);
      
      // Users can delete their own prompts
      allow delete: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid;
    }
    
    // User themes
    match /user_themes/{themeId} {
      // Users can read their own themes OR public themes
      allow read: if isAuthenticated() && 
                     (resource.data.user_id == request.auth.uid || resource.data.is_public == true);
      
      // Users can create themes with their own user_id
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid &&
                       request.resource.data.keys().hasAll(['user_id', 'name', 'is_default', 'is_public', 'colors', 'typography', 'spacing', 'borderRadius', 'shadowIntensity', 'animations', 'density', 'created_at', 'updated_at']) &&
                       request.resource.data.name.size() <= 100;
      
      // Users can update their own themes
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid &&
                       request.resource.data.user_id == request.auth.uid &&
                       (!request.resource.data.keys().hasAny(['name']) || request.resource.data.name.size() <= 100);
      
      // Users can delete their own themes
      allow delete: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid;
    }
    
    // Goals collection
    match /goals/{goalId} {
      // Users can read their own goals
      allow read: if isAuthenticated() && 
                     resource.data.user_id == request.auth.uid;
      
      // Users can create goals with their own user_id
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid &&
                       request.resource.data.keys().hasAll(['user_id', 'title', 'category', 'status', 'target_date', 'created_at', 'updated_at', 'status_changed_at', 'last_activity', 'progress_percentage']) &&
                       request.resource.data.title.size() >= 3 &&
                       request.resource.data.title.size() <= 200 &&
                       (!request.resource.data.keys().hasAny(['description']) || request.resource.data.description.size() <= 2000) &&
                       request.resource.data.category in ['career', 'health', 'personal', 'financial', 'relationships', 'learning', 'other'] &&
                       request.resource.data.status in ['not_started', 'in_progress', 'completed', 'abandoned'] &&
                       request.resource.data.progress_percentage >= 0 &&
                       request.resource.data.progress_percentage <= 100;
      
      // Users can update their own goals
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid &&
                       request.resource.data.user_id == request.auth.uid &&
                       (!request.resource.data.keys().hasAny(['title']) || (request.resource.data.title.size() >= 3 && request.resource.data.title.size() <= 200)) &&
                       (!request.resource.data.keys().hasAny(['description']) || request.resource.data.description.size() <= 2000) &&
                       (!request.resource.data.keys().hasAny(['category']) || request.resource.data.category in ['career', 'health', 'personal', 'financial', 'relationships', 'learning', 'other']) &&
                       (!request.resource.data.keys().hasAny(['status']) || request.resource.data.status in ['not_started', 'in_progress', 'completed', 'abandoned']) &&
                       (!request.resource.data.keys().hasAny(['progress_percentage']) || (request.resource.data.progress_percentage >= 0 && request.resource.data.progress_percentage <= 100));
      
      // Users can delete their own goals
      allow delete: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid;
      
      // Milestones subcollection
      match /milestones/{milestoneId} {
        // Users can read milestones if they own the parent goal
        allow read: if isAuthenticated() && 
                       get(/databases/$(database)/documents/goals/$(goalId)).data.user_id == request.auth.uid;
        
        // Users can create milestones if they own the parent goal
        allow create: if isAuthenticated() && 
                         get(/databases/$(database)/documents/goals/$(goalId)).data.user_id == request.auth.uid &&
                         request.resource.data.keys().hasAll(['goal_id', 'title', 'completed', 'order', 'created_at']) &&
                         request.resource.data.goal_id == goalId &&
                         request.resource.data.title.size() > 0 &&
                         request.resource.data.title.size() <= 200;
        
        // Users can update milestones if they own the parent goal
        allow update: if isAuthenticated() && 
                         get(/databases/$(database)/documents/goals/$(goalId)).data.user_id == request.auth.uid &&
                         request.resource.data.goal_id == goalId &&
                         (!request.resource.data.keys().hasAny(['title']) || (request.resource.data.title.size() > 0 && request.resource.data.title.size() <= 200));
        
        // Users can delete milestones if they own the parent goal
        allow delete: if isAuthenticated() && 
                         get(/databases/$(database)/documents/goals/$(goalId)).data.user_id == request.auth.uid;
      }
      
      // Progress updates subcollection
      match /progress_updates/{progressId} {
        // Users can read progress updates if they own the parent goal
        allow read: if isAuthenticated() && 
                       get(/databases/$(database)/documents/goals/$(goalId)).data.user_id == request.auth.uid;
        
        // Users can create progress updates if they own the parent goal
        allow create: if isAuthenticated() && 
                         get(/databases/$(database)/documents/goals/$(goalId)).data.user_id == request.auth.uid &&
                         request.resource.data.keys().hasAll(['goal_id', 'content', 'created_at']) &&
                         request.resource.data.goal_id == goalId &&
                         request.resource.data.content.size() > 0 &&
                         request.resource.data.content.size() <= 2000;
        
        // Users can update progress updates if they own the parent goal
        allow update: if isAuthenticated() && 
                         get(/databases/$(database)/documents/goals/$(goalId)).data.user_id == request.auth.uid &&
                         request.resource.data.goal_id == goalId &&
                         (!request.resource.data.keys().hasAny(['content']) || (request.resource.data.content.size() > 0 && request.resource.data.content.size() <= 2000));
        
        // Users can delete progress updates if they own the parent goal
        allow delete: if isAuthenticated() && 
                         get(/databases/$(database)/documents/goals/$(goalId)).data.user_id == request.auth.uid;
      }
    }
    
    // Goal-journal links collection
    match /goal_journal_links/{linkId} {
      // Users can read their own goal-journal links
      allow read: if isAuthenticated() && 
                     resource.data.user_id == request.auth.uid;
      
      // Users can create goal-journal links with their own user_id
      // Must verify ownership of both goal and journal entry
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid &&
                       request.resource.data.keys().hasAll(['goal_id', 'journal_entry_id', 'user_id', 'created_at']) &&
                       get(/databases/$(database)/documents/goals/$(request.resource.data.goal_id)).data.user_id == request.auth.uid &&
                       get(/databases/$(database)/documents/journal_entries/$(request.resource.data.journal_entry_id)).data.user_id == request.auth.uid;
      
      // Users can update their own goal-journal links
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid &&
                       request.resource.data.user_id == request.auth.uid;
      
      // Users can delete their own goal-journal links
      allow delete: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid;
    }
    
    // Voice conversations collection
    match /voice_conversations/{conversationId} {
      // Users can read their own voice conversations
      allow read: if isAuthenticated() && 
                     resource.data.user_id == request.auth.uid;
      
      // Users can create voice conversations with their own user_id
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid &&
                       request.resource.data.keys().hasAll(['user_id', 'conversation_id', 'agent_id', 'transcript', 'duration', 'started_at', 'ended_at', 'created_at']) &&
                       request.resource.data.duration >= 0 &&
                       request.resource.data.duration <= 1800; // Max 30 minutes
      
      // Users can update their own voice conversations
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid &&
                       request.resource.data.user_id == request.auth.uid;
      
      // Users can delete their own voice conversations
      allow delete: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid;
    }
    
    // Voice sessions collection
    match /voice_sessions/{sessionId} {
      // Helper function to check if session is not expired
      function isSessionValid() {
        return request.time < resource.data.expires_at;
      }
      
      // Users can read their own voice sessions
      allow read: if isAuthenticated() && 
                     resource.data.user_id == request.auth.uid;
      
      // Users can create voice sessions with their own user_id
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid &&
                       request.resource.data.keys().hasAll(['user_id', 'agent_id', 'status', 'started_at', 'last_activity', 'expires_at']) &&
                       request.resource.data.status in ['active', 'completed', 'abandoned'] &&
                       request.resource.data.expires_at > request.time; // Expiration must be in the future
      
      // Users can update their own voice sessions only if not expired
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid &&
                       request.resource.data.user_id == request.auth.uid &&
                       isSessionValid() &&
                       (!request.resource.data.keys().hasAny(['status']) || request.resource.data.status in ['active', 'completed', 'abandoned']);
      
      // Users can delete their own voice sessions
      allow delete: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid;
    }
    
    // Custom categories collection
    match /custom_categories/{categoryId} {
      // Users can read their own custom categories
      allow read: if isAuthenticated() && 
                     resource.data.user_id == request.auth.uid;
      
      // Users can create custom categories with their own user_id
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid &&
                       request.resource.data.keys().hasAll(['user_id', 'name', 'created_at']) &&
                       request.resource.data.name.size() > 0 &&
                       request.resource.data.name.size() <= 50;
      
      // Users can update their own custom categories
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid &&
                       request.resource.data.user_id == request.auth.uid &&
                       (!request.resource.data.keys().hasAny(['name']) || (request.resource.data.name.size() > 0 && request.resource.data.name.size() <= 50));
      
      // Users can delete their own custom categories
      allow delete: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid;
    }
    
    // Embeddings collection (for RAG system)
    match /embeddings/{embeddingId} {
      // Users can read their own embeddings
      allow read: if isAuthenticated() && 
                     resource.data.user_id == request.auth.uid;
      
      // Users can create embeddings with their own user_id
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid &&
                       request.resource.data.keys().hasAll(['user_id', 'content_type', 'content_id', 'created_at']);
      
      // Users can update their own embeddings
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid &&
                       request.resource.data.user_id == request.auth.uid;
      
      // Users can delete their own embeddings
      allow delete: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid;
    }
  }
}

